// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String            @id @default(cuid())
  name              String?
  email             String            @unique
  emailVerified     DateTime?
  image             String?
  password          String?
  role              UserRole          @default(CANDIDATE)
  disabilityType    DisabilityType    @default(NONE)
  pwdRequirements   PWDRequirements?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  assessments       Assessment[]      @relation("UserAssessments")
  assessmentResults Result[]
  attempts          Attempt[]
  accounts          Account[]
  sessions          Session[]
  pwdVerification   PWDVerification?
  accessibilitySettings AccessibilitySettings?
  // Course platform relations
  enrollments         CourseEnrollment[]
  moduleProgress      UserModuleProgress[]
  learningProfile     UserLearningProfile?
  reflections         Reflection[]
  taskSubmissions     TaskSubmission[]
  certificates        Certificate[]
}

model Assessment {
  id                    String                 @id @default(cuid())
  title                 String
  description           String
  subject               String
  skillLevel            SkillLevel
  duration              Int                    // in minutes
  passingScore          Int                    // percentage
  mode                  AssessmentMode
  isAdaptive            Boolean                @default(false)
  isPublished           Boolean                @default(false)
  instructorId          String                 @default("default_instructor")
  accessibilityFeatures AccessibilityFeature[]
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  questions             Question[]
  results               Result[]
  attempts              Attempt[]
  users                 User[]                 @relation("UserAssessments")
}

model Question {
  id                String          @id @default(cuid())
  assessmentId      String
  subject           String?         // Subject grouping within assessment
  prompt            String
  type              QuestionType
  options           Json?
  correctAnswer     String?
  difficulty        DifficultyLevel @default(MEDIUM)
  points            Int             @default(1)
  mandatoryKeywords Json?           // string[] of required keywords
  supportingKeywords Json?          // string[] of bonus keywords
  expectedStructure String?         // e.g. "intro-body-conclusion"
  minWords          Int?
  optimalWords      Int?
  maxWords          Int?
  minPointsRequired Int?            // minimum conceptual points needed
  assessment        Assessment      @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  answers           Answer[]
}

model Attempt {
  id                  String        @id @default(cuid())
  userId              String
  assessmentId        String
  startedAt           DateTime      @default(now())
  submittedAt         DateTime?
  extraTimeMultiplier Float         @default(1.0)
  totalScore          Float?
  gradingStatus       GradingStatus @default(PENDING)
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessment          Assessment    @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  answers             Answer[]
}

model Answer {
  id                 String   @id @default(cuid())
  attemptId          String
  questionId         String
  response           String
  aiScore            Float?
  aiFeedback         String?
  marksDistribution  Json?    // Table 1: criteria breakdown
  pointsValidation   Json?    // Table 2: required points coverage
  originalityMetrics Json?    // AI detection scores
  keywordAnalysis    Json?    // keyword match & penalty data
  integrityFlags     Json?    // suspected AI usage, POV flags
  careerMapping      Json?    // career intelligence (Subject 3 only)
  numericalValidation Json?   // numerical step-by-step validation
  diagramEvaluation  Json?    // diagram component/label/flow scoring
  createdAt          DateTime @default(now())
  attempt            Attempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question           Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Result {
  id           String       @id @default(cuid())
  userId       String
  assessmentId String
  totalScore   Float
  percentage   Float
  status       ResultStatus @default(PENDING)
  startedAt    DateTime
  completedAt  DateTime?
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessment   Assessment   @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
}

enum UserRole {
  ADMIN
  INSTRUCTOR
  CANDIDATE
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum AssessmentMode {
  ONLINE
  OFFLINE
  BLENDED
}

enum QuestionType {
  MCQ
  DESCRIPTIVE
  SHORT_ANSWER
  NUMERICAL
  DIAGRAM
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum ResultStatus {
  PENDING
  COMPLETED
  FAILED
  PASSED
}

enum GradingStatus {
  PENDING
  AI_EVALUATED
  FINALIZED
}

enum AccessibilityFeature {
  SCREEN_READER
  TEXT_TO_SPEECH
  VOICE_TO_TEXT
  HIGH_CONTRAST
  KEYBOARD_NAVIGATION
  LARGE_TEXT
  SIGN_LANGUAGE
  EXTENDED_TIME
}

model PWDRequirements {
  id                      String                 @id @default(cuid())
  userId                  String                 @unique
  isVisuallyImpaired      Boolean                @default(false)
  isHearingImpaired       Boolean                @default(false)
  isMotorImpaired         Boolean                @default(false)
  isCognitiveImpaired     Boolean                @default(false)
  requiresAssistiveTech   Boolean                @default(false)
  preferredAccommodations AccessibilityFeature[]
  additionalNotes         String?
  user                    User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
}

model PWDVerification {
  id                String             @id @default(cuid())
  userId            String             @unique
  certificateUUID   String?
  issuingAuthority  String?
  disabilityType    String?
  disabilityPercent Int?
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt        DateTime?
  createdAt         DateTime           @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AccessibilitySettings {
  id                     String      @id @default(cuid())
  userId                 String      @unique
  highContrast           Boolean     @default(false)
  textToSpeech           Boolean     @default(false)
  speechToText           Boolean     @default(false)
  voiceNavigationEnabled Boolean     @default(false)
  preferredInputMethod   InputMethod @default(KEYBOARD)

  // Supervisor-provisioned accommodation fields
  largeInteractionMode   Boolean     @default(false)
  largeText              Boolean     @default(false)
  voiceGuidanceEnabled   Boolean     @default(false)
  autoAdvanceQuestions   Boolean     @default(false)
  extraTimeMultiplier    Float       @default(1.0)
  simplifiedMode         Boolean     @default(false)
  lockedBySupervisor     Boolean     @default(false)
  lockedAt               DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum InputMethod {
  KEYBOARD
  VOICE
  MIXED
}

enum DisabilityType {
  NONE
  VISUAL
  MOTOR
  HEARING
  COGNITIVE
  SPEECH
}

// ──────────────────────────────────────────────────
// COURSE PLATFORM MODELS
// ──────────────────────────────────────────────────

enum CourseType {
  STANDARD
  SOCIAL_CONFIDENCE
}

model Course {
  id            String            @id @default(cuid())
  title         String
  description   String            @db.Text
  objectives    String[]
  outcomes      String[]
  subject       String
  skillLevel    SkillLevel
  durationHours Int               @default(6)
  isPublished   Boolean           @default(false)
  courseType    CourseType        @default(STANDARD)
  instructorId  String
  thumbnailUrl  String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  modules       Module[]
  enrollments   CourseEnrollment[]
}

model Module {
  id                  String               @id @default(cuid())
  courseId            String
  order               Int                  // 1–5
  title               String
  conceptText         String               @db.Text
  simplifiedText      String?              @db.Text
  videoUrl1           String?              // Concept video
  videoUrl2           String?              // Case example video
  practicePrompt      String?              @db.Text
  reflectionPrompt    String               @default("Reflect on what you learned in this module.")
  reflectionRequired  Boolean              @default(true)
  minReflectionWords  Int                  @default(50)
  course              Course               @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions           ModuleQuestion[]
  progress            UserModuleProgress[]
  reflections         Reflection[]
  taskSubmissions     TaskSubmission[]
}

model ModuleQuestion {
  id            String       @id @default(cuid())
  moduleId      String
  prompt        String
  type          QuestionType @default(MCQ)
  options       Json?        // string[]
  correctAnswer String?
  explanation   String?      // shown after incorrect answer
  points        Int          @default(1)
  module        Module       @relation(fields: [moduleId], references: [id], onDelete: Cascade)
}

model CourseEnrollment {
  id            String    @id @default(cuid())
  userId        String
  courseId      String
  enrolledAt    DateTime  @default(now())
  completedAt   DateTime?
  certificateId String?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
}

model UserModuleProgress {
  id                  String   @id @default(cuid())
  userId              String
  moduleId            String
  // Component scores 0–100 (server-calculated only)
  lessonScore         Float    @default(0)  // 20% weight
  videoScore          Float    @default(0)  // 15% weight
  practiceScore       Float    @default(0)  // 20% weight
  theoryScore         Float    @default(0)  // 25% weight
  taskScore           Float    @default(0)  // 20% weight
  // Weighted total 0–100
  totalProgress       Float    @default(0)
  // State flags
  lessonRead          Boolean  @default(false)
  videoWatched        Boolean  @default(false)
  quizPassed          Boolean  @default(false)
  reflectionSubmitted Boolean  @default(false)
  practiceSubmitted   Boolean  @default(false)
  simplifiedMode      Boolean  @default(false)
  quizFailCount       Int      @default(0)
  timeSpentMinutes    Int      @default(0)
  startedAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  module              Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
}

model UserLearningProfile {
  id                   String   @id @default(cuid())
  userId               String   @unique
  weakTopics           String[]
  strongTopics         String[]
  avgQuizAccuracy      Float    @default(0)
  avgReflectionQuality Float    @default(0)
  learningSpeed        String   @default("NORMAL")  // SLOW | NORMAL | FAST
  emotionalTone        String   @default("NEUTRAL")  // NERVOUS | NEUTRAL | CONFIDENT
  socialConfidenceScore Float?
  preferSimplified     Boolean  @default(false)
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Reflection {
  id           String   @id @default(cuid())
  userId       String
  moduleId     String
  content      String   @db.Text
  wordCount    Int
  aiScore      Float?
  aiFeedback   String?  @db.Text
  submittedAt  DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  module       Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
}

model TaskSubmission {
  id            String   @id @default(cuid())
  userId        String
  moduleId      String
  taskType      String   // SAFE_TASK | INTERMEDIATE | ADVANCED | CUSTOM
  description   String   @db.Text
  fearRating    Int?     // 1–10 (social confidence course)
  whyDifficult  String?  @db.Text
  aiBreakdown   String?  @db.Text
  aiFeedback    String?  @db.Text
  submittedAt   DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  module        Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
}

model Certificate {
  id              String   @id @default(cuid())
  userId          String
  courseId        String
  candidateName   String
  courseName      String
  finalScore      Float
  modeUsed        String
  integrityPassed Boolean  @default(true)
  growthSummary   String?  @db.Text
  issuedAt        DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
